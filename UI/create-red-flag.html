<!DOCTYPE html>
<html>
<head>
	<title></title>

	<link rel="stylesheet" type="text/css" href="assets/css/ireporter.css" />
	<link rel="stylesheet" type="text/css" href="assets/css/navbar2.css" />
	<link rel="stylesheet" type="text/css" href="assets/css/font-awesome.min.css" />
	<link rel="stylesheet" type="text/css" href="assets/css/user.css" />

	<script src="assets/js/ireporter.js"></script>
	<script src="assets/js/validator.js"></script>
	<script src="assets/js/api.js"></script>
	<script src="assets/js/app.js"></script>
	<script>
	let submitBtn = null;

	function onSubmit(event, form, mode, http) {
	  event.preventDefault();

	  submitBtn.disabled = true;

	  form.hideFieldErrors();

	  	const validator = new FormValidator('incident-form');
	  	const rules = {
	  	  title: {
	  	  	required: 'Title is required',
	  	  },
	  	  comment: {
	  	  	required: 'Comment is required',
	  	  	'min_length[40]': 'Comment should be at least 40 characters',
	  	  },
	  	  lat: {
	  	  	optional: true,
	  	  	latitude: 'Latitude must be between -90 and 90',
	  	  },
	  	  long: {
	  	  	optional: true,
	  	  	longitude: 'Longitude must be between -180 and 180',
	  	  }
	  	};
	  	if (validator.validate(rules)) {
	  	  const url = (mode == 'edit' ? `red-flags/${http.params.id}` : 'red-flags');
	      const endpoint = http.api(url).body({
	      	title: form.field('title').value(),
	      	comment: form.field('comment').value(),
	      	lat: form.field('lat').value(),
	      	long: form.field('long').value(),
	      });
	      const onApiSuccess = (data) => {
	      	http.redirect(`./view-red-flag.html?id=${data[0].id}`);
	      };
	      const onApiError = (error) => {
	      	submitBtn.disabled = false;

	      	app.toast.error('Failed to ' + (mode == 'edit' ? 'edit' : 'create') + ' red-flag record');
	      	console.log(error);
	      };

	      if (mode == 'add') {
	      	endpoint.post(onApiSuccess, onApiError);
	      } else if (mode == 'edit') {
	      	endpoint.patch(onApiSuccess, onApiError);
	      }
	  	} else {
	  	  form.showFieldErrors(validator.getErrors());

	  	  submitBtn.disabled = false;
	  	}
	  }

	app.setAuthRequired(true);
	app.ready((http, dom) => {
      dom.selector('.auth-logout').click(app.logout);
      
	  submitBtn = document.getElementById('submit-btn');

      const mode = http.params['action'] == 'edit' && typeof http.params['id'] !== 'undefined' ? 'edit' : 'add';
      
      const incidentForm = app.form('incident-form');

      // Pre-populate the form if mode is edit
      if (mode == 'edit') {
      	document.title = 'Edit Red Flag | iReporter';
      	dom.selector('.js-text-header').html('Edit Red Flag');
      	submitBtn.value = 'Save';

      	http.api(`red-flags/${http.params.id}`).get((data) => {
      	  const incident = data[0];

          incidentForm.field('title').value(incident.title);

          incidentForm.field('comment').value(incident.comment);

          if (incident.latitude && incident.longitude) {
          	incidentForm.field('lat').value(incident.latitude);
          	incidentForm.field('long').value(incident.longitude);
          }

          incidentForm.onsubmit((event, form) => {
          	onSubmit(event, form, mode, http);
          });
      	}, (error) => {

      	});
      } else if (mode == 'add') {
      	document.title = 'Create a Red Flag | iReporter';
      	dom.selector('.js-text-header').html('Create a Red Flag');
      	submitBtn.value = 'Create a Red Flag';

      	incidentForm.onsubmit((event, form) => {
      		onSubmit(event, form, mode, http);
      	});
      }
	});
	app.start();
	</script>
</head>
<body>
	<div class="red-bg">
		<div class="container">
			<div id="navbar">
				<a href="dashboard.html" class="sitename">iReporter</a>
				<div class="navbar-menu">
					<ul>
						<li><a href="red-flags.html">Red Flags</a></li>
						<li><a href="interventions.html">Interventions</a></li>
						<li class="dropdown">
							<a href="#">Account <i class="fa fa-caret-down"></i></a>
							<ul class="dropdown-menu">
								<li><a href="profile.html">My Profile</a></li>
								<li><a href="#" class="auth-logout">Log out</a></li>
							</ul>
						</li>
					</ul>
				</div>
				<div class="clearfix"></div>
			</div>
		</div>
	</div>
	<div>
		<div class="container">
			<div class="header-container">
				<div class="header js-text-header"></div>
				<div style="margin-top:9px;"><small><span class="required">*</span> Required fields</small></div>
			</div>
			<div>
				<form role="form" id="incident-form">
					<div class="field-section">
						<label>Title <span class="required">*</span></label>
						<input type="text" name="title" class="text-field" />
						<div class="error title"></div>
					</div>
					<div class="field-section">
						<label>Comment <span class="required">*</span></label>
						<textarea name="comment" class="text-field" rows="14"></textarea>
						<div class="error comment"></div>
					</div>
					<div class="form-section">
						<div class="form-section-header"><i class="fa fa-map-marker"></i> Add Geo Location</div>
						<div class="form-section-body">
							<div class="grid-container">
								<div class="grid-10">
									<label>Lat</label>
									<input type="text" name="lat" class="text-field" />
								</div>
								<div class="grid-10">
									<label>Long</label>
									<input type="text" name="long" class="text-field" />
								</div>
								<div class="clearfix"></div>
							</div>

							<div class="error lat"></div>
							<div class="error long"></div>
						</div>
					</div>
					<div class="field-section">
						<input type="submit" class="button" value="Create a Red Flag" id="submit-btn" />
					</div>
				</form>
			</div>
		</div>
	</div>
</body>
</html>